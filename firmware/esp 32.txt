/*
 * ESP32 Relay Controller - Updated with Stable Connection Handling
 */

#include <WiFi.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>

// === WIFI CONFIGURATION ===
const char* WIFI_SSID = "Test";           // Your WiFi network
const char* WIFI_PASSWORD = "test1234";   // Your WiFi password

// MQTT broker connection settings
const char* MQTT_BROKER = "sting";      // Your computer's IP
const int MQTT_PORT = 1884;                     // MQTT port
const char* MQTT_CLIENT_ID = "esp32_relay_1";   // Client ID

// Device identification
const char* HOME_ID = "home1";
const char* DEVICE_ID = "living_room_bulb";

// Hardware pin configuration
const int RELAY_PIN = 23;

// MQTT topic strings
char cmdTopic[100];
char powerTopic[100];
char energyTopic[100];
char alertTopic[100];
char statusTopic[100];

// Network and MQTT client
WiFiClient wifiClient;
PubSubClient mqttClient(wifiClient);

// Global state tracking
bool relayState = false;
float totalEnergyWh = 0;
unsigned long lastEnergyUpdate = 0;
unsigned long lastHeartbeat = 0;

// Connection management
unsigned long lastReconnectAttempt = 0;
const unsigned long RECONNECT_INTERVAL = 5000;
bool wifiConnected = false;

void setupTopics() {
  snprintf(cmdTopic, sizeof(cmdTopic), "home/%s/cmd/%s/set", HOME_ID, DEVICE_ID);
  snprintf(powerTopic, sizeof(powerTopic), "home/%s/sensor/%s/power", HOME_ID, DEVICE_ID);
  snprintf(energyTopic, sizeof(energyTopic), "home/%s/sensor/%s/energy", HOME_ID, DEVICE_ID);
  snprintf(alertTopic, sizeof(alertTopic), "home/%s/event/alert", HOME_ID);
  snprintf(statusTopic, sizeof(statusTopic), "home/%s/sensor/%s/status", HOME_ID, DEVICE_ID);
}

void connectToWiFi() {
  Serial.println();
  Serial.println("ðŸ“¶ Connecting to WiFi...");
  Serial.print("SSID: ");
  Serial.println(WIFI_SSID);
  
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(1000);
    Serial.print(".");
    attempts++;
  }
  
  if (WiFi.status() == WL_CONNECTED) {
    wifiConnected = true;
    Serial.println();
    Serial.println("âœ… WiFi CONNECTED!");
    Serial.print("ðŸ“± IP Address: ");
    Serial.println(WiFi.localIP());
    Serial.print("ðŸ“¶ Signal Strength: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
  } else {
    wifiConnected = false;
    Serial.println();
    Serial.println("âŒ WiFi connection failed");
  }
}

boolean reconnectMQTT() {
  Serial.println("ðŸ”Œ Attempting MQTT connection...");
  
  if (mqttClient.connect(MQTT_CLIENT_ID)) {
    Serial.println("âœ… MQTT connected!");
    mqttClient.subscribe(cmdTopic);
    Serial.println("âœ… Subscribed to command topic");
    
    // Publish initial states
    publishCurrentState();
    publishEnergy();
    publishStatus();
    
    return true;
  } else {
    Serial.print("âŒ MQTT connection failed, rc=");
    Serial.println(mqttClient.state());
    return false;
  }
}

void publishCurrentState() {
  StaticJsonDocument<200> doc;
  doc["ts"] = millis();
  doc["watts"] = relayState ? 100 : 0;
  doc["voltage"] = 230;
  doc["current"] = relayState ? 0.26 : 0.0;
  
  String jsonString;
  serializeJson(doc, jsonString);
  mqttClient.publish(powerTopic, jsonString.c_str());
  Serial.println("ðŸ“¤ Published current state");
}

void setup() {
  Serial.begin(115200);
  delay(3000);
  
  Serial.println();
  Serial.println("ðŸš€ ESP32 RELAY CONTROLLER - UPDATED");
  Serial.println("===================================");
  
  // Relay setup
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, LOW);
  Serial.println("âœ… Relay initialized (OFF)");
  
  // Topic setup
  setupTopics();
  Serial.print("ðŸ“¡ Command topic: ");
  Serial.println(cmdTopic);
  
  // WiFi connection
  connectToWiFi();
  
  if (wifiConnected) {
    // MQTT setup
    mqttClient.setServer(MQTT_BROKER, MQTT_PORT);
    
    mqttClient.setCallback([](char* topic, byte* payload, unsigned int length) {
      Serial.println();
      Serial.println("ðŸŽ¯ MQTT COMMAND RECEIVED!");
      Serial.print("Topic: ");
      Serial.println(topic);
      
      Serial.print("Message: ");
      for (int i = 0; i < length; i++) {
        Serial.print((char)payload[i]);
      }
      Serial.println();
      
      StaticJsonDocument<200> doc;
      DeserializationError error = deserializeJson(doc, payload, length);
      
      if (!error && doc.containsKey("on")) {
        bool newState = doc["on"];
        digitalWrite(RELAY_PIN, newState ? LOW : HIGH);
        relayState = newState;
        
        Serial.print("ðŸ’¡ RELAY: ");
        Serial.println(newState ? "ON ðŸŸ¢" : "OFF ðŸ”´");
        
        publishCurrentState();
      } else {
        Serial.println("âš ï¸  Invalid JSON or missing 'on' field");
      }
    });
    
    // Initial MQTT connection
    if (reconnectMQTT()) {
      Serial.println();
      Serial.println("ðŸŽ‰ SYSTEM READY!");
      Serial.println("Send commands to:");
      Serial.println(cmdTopic);
      Serial.println("Message: {\"on\": true}  or  {\"on\": false}");
    }
  }
  
  lastEnergyUpdate = millis();
  lastHeartbeat = millis();
}

void loop() {
  // Check WiFi connection
  if (WiFi.status() != WL_CONNECTED) {
    if (wifiConnected) {
      Serial.println("ðŸ“¶ WiFi disconnected!");
      wifiConnected = false;
    }
    connectToWiFi();
  } else {
    if (!wifiConnected) {
      wifiConnected = true;
      Serial.println("âœ… WiFi reconnected!");
    }
  }
  
  // MQTT connection management
  if (wifiConnected) {
    if (!mqttClient.connected()) {
      unsigned long now = millis();
      if (now - lastReconnectAttempt > RECONNECT_INTERVAL) {
        lastReconnectAttempt = now;
        if (reconnectMQTT()) {
          lastReconnectAttempt = 0;
        }
      }
    } else {
      // MQTT is connected - normal operation
      mqttClient.loop();
      
      // Periodic energy updates
      if (millis() - lastEnergyUpdate > 60000) {
        updateEnergy();
        publishEnergy();
        lastEnergyUpdate = millis();
      }
      
      // Periodic heartbeat
      if (millis() - lastHeartbeat > 300000) {
        publishStatus();
        lastHeartbeat = millis();
      }
    }
  }
  
  delay(1000);
}

void updateEnergy() {
  unsigned long currentMillis = millis();
  unsigned long elapsedMillis = currentMillis - lastEnergyUpdate;
  
  if (relayState) {
    float hours = elapsedMillis / 3600000.0;
    float watts = 100.0;
    totalEnergyWh += watts * hours;
  }
}

void publishEnergy() {
  StaticJsonDocument<200> doc;
  doc["ts"] = millis();
  doc["wh_total"] = totalEnergyWh;
  
  String jsonString;
  serializeJson(doc, jsonString);
  mqttClient.publish(energyTopic, jsonString.c_str());
  
  Serial.print("âš¡ Published energy: ");
  Serial.print(totalEnergyWh);
  Serial.println(" Wh");
}

void publishStatus() {
  StaticJsonDocument<300> doc;
  doc["ts"] = millis();
  doc["uptime"] = millis() / 1000;
  doc["rssi"] = WiFi.RSSI();
  doc["relay_state"] = relayState;
  doc["ip"] = WiFi.localIP().toString();
  doc["free_heap"] = ESP.getFreeHeap();
  
  String jsonString;
  serializeJson(doc, jsonString);
  mqttClient.publish(statusTopic, jsonString.c_str());
  
  Serial.println("ðŸ’“ Published status/heartbeat");
}

void publishAlert(const char* severity, const char* message) {
  StaticJsonDocument<300> doc;
  doc["ts"] = millis();
  doc["deviceId"] = DEVICE_ID;
  doc["severity"] = severity;
  doc["message"] = message;
  doc["type"] = "device";
  
  String jsonString;
  serializeJson(doc, jsonString);
  mqttClient.publish(alertTopic, jsonString.c_str());
  
  Serial.print("ðŸš¨ Alert: [");
  Serial.print(severity);
  Serial.print("] ");
  Serial.println(message);
}