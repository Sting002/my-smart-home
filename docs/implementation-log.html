<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Smart Home – Implementation Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --fg: #111827; --muted: #4b5563; --accent: #10b981; --bg: #ffffff; }
    html, body { margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color: var(--fg); background: var(--bg); }
    .wrap { max-width: 860px; margin: 2rem auto; padding: 0 1rem; }
    h1 { font-size: 1.8rem; margin: 0 0 0.25rem; }
    .subtitle { color: var(--muted); margin-bottom: 1rem; }
    h2 { margin-top: 2rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.25rem; }
    h3 { margin-top: 1rem; }
    code { background: #f3f4f6; padding: 0.1rem 0.35rem; border-radius: 4px; }
    pre { background: #111827; color: #e5e7eb; padding: 0.75rem; border-radius: 6px; overflow: auto; }
    ul { line-height: 1.5; }
    .file { font-weight: 600; margin-top: 1rem; }
    .small { color: var(--muted); font-size: 0.9rem; }
    .ok { color: var(--accent); font-weight: 600; }
    @media print { .wrap { margin: 0.5in auto; } a { color: inherit; text-decoration: none; } }
  </style>
  <meta name="generator" content="Codex CLI" />
  <meta name="created" content="auto" />
  <meta name="description" content="Implementation log of code review fixes across MQTT lifecycle, routing, CSRF, and UI." />
  <link rel="canonical" href="#" />
  <meta name="format-detection" content="telephone=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: blob:; style-src 'unsafe-inline'" />
  <base href="/" />
  <meta id="ts" />
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('ts');
      if (el) el.setAttribute('content', new Date().toISOString());
    });
  </script>
  <!-- To export to PDF: Use a Chromium browser's Print dialog or headless flag. -->
</head>
<body>
  <div class="wrap">
    <h1>Implementation Log</h1>
    <div class="subtitle small">Scope: Fix MQTT lifecycle, routing, CSRF, and polish. Generated by Codex CLI.</div>

    <h2>Overview</h2>
    <ul>
      <li>Centralized MQTT connection in <code>EnergyProvider</code>; removed duplicate connects; hardened reconnect and teardown.</li>
      <li>Fixed onboarding failure leak; settings now triggers reconnect; connection banner reflects true status.</li>
      <li>Stabilized subscribe/unsubscribe callbacks to avoid leaks; corrected login redirect payload.</li>
      <li>Aligned CSRF client and server; added CSRF header on mutating requests.</li>
      <li>Security polish: <code>wss:</code> in CSP; auth cookie gets <code>Secure</code> in production and includes username.</li>
      <li>Minor UI/UX: fixed currency symbols and back button glyphs.</li>
    </ul>

    <h2>Changes By File</h2>

    <div class="file">src/pages/Onboarding.tsx:49</div>
    <ul>
      <li>On failed connect, call <code>mqttService.disconnect()</code> to terminate auto-reconnect from the failed attempt.</li>
    </ul>

    <div class="file">src/services/mqttService.ts:70</div>
    <ul>
      <li>Track <code>currentUrl</code>; set on connect.</li>
      <li><code>connectAndWait</code> now:
        <ul>
          <li>Returns immediately if already connected to the same URL.</li>
          <li>Disconnects when switching brokers.</li>
          <li>Disconnects on timeout/error to avoid lingering clients.</li>
        </ul>
      </li>
      <li><code>disconnect()</code> preserves status listeners so UIs remain subscribed across reconnects.</li>
    </ul>

    <div class="file">src/contexts/EnergyContext.tsx:77</div>
    <ul>
      <li>Owns MQTT connection; reacts to onboarding and <code>brokerUrl</code> changes; updates <code>connected</code> on status events.</li>
    </ul>

    <div class="file">src/components/AppLayout.tsx:1</div>
    <ul>
      <li>Removed duplicate connect effect and service import.</li>
    </ul>

    <div class="file">src/hooks/useMQTTDevice.ts:43</div>
    <ul>
      <li>Use stable <code>onPower</code>/<code>onEnergy</code> handlers so <code>unsubscribe</code> removes the exact function references.</li>
    </ul>

    <div class="file">src/routes/ProtectedRoute.tsx:13</div>
    <ul>
      <li>Login redirect stores <code>from</code> as <code>loc.pathname</code> (string), matching Login’s expectation.</li>
    </ul>

    <div class="file">src/components/ConnectionStatus.tsx:1</div>
    <ul>
      <li>Banner listens to <code>mqttService.onStatusChange</code>; shows current status instead of polling localStorage.</li>
    </ul>

    <div class="file">src/api/csrf.ts:17</div>
    <ul>
      <li>Switched to <code>/api/csrf</code> endpoint; read <code>{ token }</code> shape.</li>
    </ul>

    <div class="file">src/api/client.ts:3</div>
    <ul>
      <li>Attach <code>X-CSRF-Token</code> to non-GET requests via <code>ensureCsrfToken</code>.</li>
    </ul>

    <div class="file">Backend/middleware/auth.cjs:76</div>
    <ul>
      <li>Token payload now includes <code>username</code>; set/clear auth cookie adds <code>Secure</code> in production.</li>
    </ul>

    <div class="file">Backend/server.cjs:54</div>
    <ul>
      <li>Added <code>wss:</code> to CSP <code>connect-src</code> for secure MQTT.</li>
    </ul>

    <div class="file">src/pages/Settings.tsx:50</div>
    <ul>
      <li>Saving broker URL now disconnects and reconnects immediately; catch now logs errors (ESLint <code>no-empty</code>).</li>
    </ul>

    <div class="file">src/utils/energyCalculations.ts:21</div>
    <ul>
      <li>Corrected currency symbols for EUR (€) and GBP (£).</li>
    </ul>

    <div class="file">src/pages/AddDevice.tsx</div>
    <ul>
      <li>Replaced stray control character in Back button with “← Back”.</li>
    </ul>

    <div class="file">src/pages/DeviceDetail.tsx</div>
    <ul>
      <li>Replaced stray control character in Back button with “← Back”.</li>
    </ul>

    <h2>Validation</h2>
    <ul>
      <li><span class="ok">OK</span> Type-check: <code>npx tsc --noEmit</code></li>
    </ul>

    <h2>How To Export To PDF</h2>
    <ol>
      <li>Open this file (<code>docs/implementation-log.html</code>) in a Chromium-based browser.</li>
      <li>Use “Print” → Destination “Save as PDF”.</li>
      <li>Or, via CLI on Windows with Edge: <code>msedge --headless --print-to-pdf=implementation-log.pdf docs/implementation-log.html</code></li>
    </ol>

    <p class="small">Generated by Codex CLI. Timestamps and line numbers are approximate to current workspace.</p>
  </div>
</body>
</html>

